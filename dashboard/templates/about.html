{% load static %}

<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>À propos | Dashboard </title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="{% static 'assets/css/dashboard-theme.css' %}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.12/dist/sweetalert2.min.css">
</head>
<body>
  <!-- Mobile Menu Toggle -->
  <div class="mobile-menu-toggle" id="mobileMenuToggle">
    <i class="fas fa-bars"></i>
  </div>

  <!-- Off-canvas Mobile Menu -->
  <div class="mobile-menu-overlay" id="mobileMenuOverlay"></div>
  <aside class="sidebar mobile-sidebar" id="mobileSidebar">
    <div class="mobile-menu-header">
      <div class="profile">
        <div class="home__img" style="margin: 0 auto;">
          <svg class="home__blob" viewBox="0 0 200 187" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
            <mask id="mask0" mask-type="alpha">
              <path d="M190.312 36.4879C206.582 62.1187 201.309 102.826 182.328 134.186C163.346 165.547 130.807 187.559 100.226 186.353C69.6454 185.297 41.0228 161.023 21.7403 129.362C2.45775 97.8511 -7.48481 59.1033 6.67581 34.5279C20.9871 10.1032 59.7028 -0.149132 97.9666 0.00163737C136.23 0.303176 174.193 10.857 190.312 36.4879Z"/>
            </mask>
            <g mask="url(#mask0)">
              <path d="M190.312 36.4879C206.582 62.1187 201.309 102.826 182.328 134.186C163.346 165.547 130.807 187.559 100.226 186.353C69.6454 185.297 41.0228 161.023 21.7403 129.362C2.45775 97.8511 -7.48481 59.1033 6.67581 34.5279C20.9871 10.1032 59.7028 -0.149132 97.9666 0.00163737C136.23 0.303176 174.193 10.857 190.312 36.4879Z"/>
              <image class="home__blob-img" id="sidebarProfileImg" x="12" y="18" href="" alt="Profile Image"/>
            </g>
          </svg>
        </div>
        {% if user_profile %}
        <h3 id="mobileSidebarUserName">{{ user_profile.first_name }} {{ user_profile.last_name }}</h3>
        <p id="mobileSidebarUserRole">{{ user.username }}</p>
        {% else %}
        <h3 id="mobileSidebarUserName">{{ user.first_name }} {{ user.last_name }}</h3>
        <p id="mobileSidebarUserRole">{{ user.username }}</p>
        {% endif %}
      </div>
      <button class="mobile-menu-close" id="mobileMenuClose">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <nav>
      <a href="/dashboard"><i class="fas fa-th-large"></i>Dashboard</a>
      <a href="/about" class="active"><i class="fas fa-user"></i>About</a>
      <a href="/skills"><i class="fas fa-code"></i>Skills</a>
      <a href="/qualifications"><i class="fas fa-graduation-cap"></i>Qualifications</a>
      <a href="/services"><i class="fas fa-briefcase"></i>Services</a>
      <a href="/portfolio"><i class="fas fa-folder-open"></i>Portfolio</a>
      <a href="/testimonials"><i class="fas fa-comments"></i>Testimonial</a>
      <a href="/contact"><i class="fas fa-envelope"></i>Contact</a>
    </nav>
  </aside>

  <!-- Desktop Sidebar -->
  <aside class="dashboard-sidebar desktop-sidebar">
    <div class="profile">
      <div class="home__img" style="margin: 0 auto;">
        <svg class="home__blob" viewBox="0 0 200 187" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
          <mask id="mask0" mask-type="alpha">
            <path d="M190.312 36.4879C206.582 62.1187 201.309 102.826 182.328 134.186C163.346 165.547 130.807 187.559 100.226 186.353C69.6454 185.297 41.0228 161.023 21.7403 129.362C2.45775 97.8511 -7.48481 59.1033 6.67581 34.5279C20.9871 10.1032 59.7028 -0.149132 97.9666 0.00163737C136.23 0.303176 174.193 10.857 190.312 36.4879Z"/>
          </mask>
          <g mask="url(#mask0)">
            <path d="M190.312 36.4879C206.582 62.1187 201.309 102.826 182.328 134.186C163.346 165.547 130.807 187.559 100.226 186.353C69.6454 185.297 41.0228 161.023 21.7403 129.362C2.45775 97.8511 -7.48481 59.1033 6.67581 34.5279C20.9871 10.1032 59.7028 -0.149132 97.9666 0.00163737C136.23 0.303176 174.193 10.857 190.312 36.4879Z"/>
            <!-- <i class="fa fa-user"></i> -->
            <image class="home__blob-img" id="sidebarProfileImg" x="12" y="18" href="" alt="Profile Image"/>
          </g>
        </svg>
      </div>
      {% if user_profile %}
      <h3 id="sidebarUserName">{{ user_profile.first_name }} {{ user_profile.last_name }}</h3>
      <p id="sidebarUserRole">{{ user.username }}</p>
      {% else %}
      <h3 id="sidebarUserName">{{ user.first_name }} {{ user.last_name }}</h3>
      <p id="sidebarUserRole">{{ user.username }}</p>
      {% endif %}
    </div>
    <nav>
      <a href="/dashboard"><i class="fas fa-th-large"></i>Dashboard</a>
      <a href="/about" class="active"><i class="fas fa-user"></i>About</a>
      <a href="/skills"><i class="fas fa-code"></i>Skills</a>
      <a href="/qualifications"><i class="fas fa-graduation-cap"></i>Qualifications</a>
      <a href="/services"><i class="fas fa-briefcase"></i>Services</a>
      <a href="/portfolio"><i class="fas fa-folder-open"></i>Portfolio</a>
      <a href="/testimonials"><i class="fas fa-comments"></i>Testimonial</a>
      <a href="/contact"><i class="fas fa-envelope"></i>Contact</a>
    </nav>
  </aside>
  
  <main class="dashboard-main">
    <div class="dashboard-card">
      <div class="dashboard-title">{% if is_edit %}Modifier les informations{% else %}À propos de moi{% endif %}</div>
      <div class="dashboard-desc">{% if is_edit %}Modifiez les informations de votre profil.{% else %}Ajoutez les informations de votre profil pour les afficher sur votre site public.{% endif %}</div>
      <form id="aboutForm" enctype="multipart/form-data">
        <div class="form-row">
          <div class="form-group">
            <label for="first_name">Prénom *</label>
            <input type="text" id="first_name" name="first_name" required>
            <div class="input-error" id="error-first_name"></div>
          </div>
          <div class="form-group">
            <label for="last_name">Nom *</label>
            <input type="text" id="last_name" name="last_name" required>
            <div class="input-error" id="error-last_name"></div>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="profession">Profession *</label>
            <input type="text" id="profession" name="profession" required>
            <div class="input-error" id="error-profession"></div>
          </div>
          <div class="form-group">
            <label for="company_name">Nom de l'entreprise</label>
            <input type="text" id="company_name" name="company_name">
            <div class="input-error" id="error-company_name"></div>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="years_experience">Années d'expérience *</label>
            <input type="number" id="years_experience" name="years_experience" min="0" required>
            <div class="input-error" id="error-years_experience"></div>
          </div>
          <div class="form-group">
            <label for="completed_projects">Projets terminés *</label>
            <input type="number" id="completed_projects" name="completed_projects" min="0" required>
            <div class="input-error" id="error-completed_projects"></div>
          </div>
        </div>

        <div class="form-group">
          <label for="email">Email *</label>
          <input type="email" id="email" name="email" required>
          <div class="input-error" id="error-email"></div>
        </div>

        <div class="form-group">
          <label for="phone">Téléphone *</label>
          <input type="tel" id="phone" name="phone" required>
          <div class="input-error" id="error-phone"></div>
        </div>

        <div class="form-group">
          <label for="address">Adresse *</label>
          <textarea id="address" name="address" required></textarea>
          <div class="input-error" id="error-address"></div>
        </div>

        <div class="form-group">
          <label for="bio">Biographie *</label>
          <textarea id="bio" name="bio" placeholder="Votre biographie" required></textarea>
          <div class="input-error" id="error-bio"></div>
        </div>

        <div class="form-group">
          <label for="photo">Photo de profil</label>
          <input type="file" id="photo" name="photo" accept="image/*">
          <div class="input-error" id="error-photo"></div>
        </div>

        <div class="form-group">
          <label for="cv">CV</label>
          <input type="file" id="cv" name="cv" accept=".pdf,.doc,.docx">
          <div class="input-error" id="error-cv"></div>
        </div>

        <button type="submit">{% if is_edit %}Modifier{% else %}Enregistrer{% endif %}</button>
        {% if is_edit %}
        <input type="hidden" id="edit_item_id" value="{{ item_id }}">
        {% endif %}
        <div id="form-status"></div>
      </form>
    </div>
  </main>

  
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.12/dist/sweetalert2.all.min.js"></script>
  <script>
    // Determine edit mode from hidden input
    const isEditMode = !!document.getElementById('edit_item_id');
    const itemId = isEditMode ? document.getElementById('edit_item_id').value : null;
    
    async function loadAboutData(id) {
      try {
        const response = await fetch(`{{ base_url }}/api/about/edit/${id}/`);
        const result = await response.json();
        if (result.success && result.data) {
          const data = result.data;
          
          // Pre-fill form fields
          document.querySelector('input[name="first_name"]').value = data.first_name || '';
          document.querySelector('input[name="last_name"]').value = data.last_name || '';
          document.querySelector('input[name="profession"]').value = data.profession || '';
          document.querySelector('input[name="company_name"]').value = data.company_name || '';
          document.querySelector('input[name="years_experience"]').value = data.years_experience || '';
          document.querySelector('input[name="completed_projects"]').value = data.completed_projects || '';
          document.querySelector('input[name="email"]').value = data.email || '';
          document.querySelector('input[name="phone"]').value = data.phone || '';
          document.querySelector('textarea[name="address"]').value = data.address || '';
          document.querySelector('textarea[name="bio"]').value = data.bio || '';
        }
      } catch (err) {
        console.error('Failed to load about data:', err);
      }
    }

    document.getElementById('aboutForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      // Clear all per-field errors
      const fields = ['first_name', 'last_name', 'profession', 'company_name', 'years_experience', 
                     'completed_projects', 'email', 'phone', 'address', 'bio', 'photo', 'cv'];
      fields.forEach(field => {
        document.getElementById('error-' + field).textContent = '';
      });

      const form = e.target;
      let hasError = false;

      // Client-side validation
      const first_name = form.first_name.value.trim();
      const last_name = form.last_name.value.trim();
      const profession = form.profession.value.trim();
      const years_experience = form.years_experience.value;
      const completed_projects = form.completed_projects.value;
      const email = form.email.value.trim();
      const phone = form.phone.value.trim();
      const address = form.address.value.trim();
      const bio = form.bio.value.trim();

      if (!first_name) {
        document.getElementById('error-first_name').textContent = "Le prénom est obligatoire.";
        hasError = true;
      } else if (first_name.length < 2) {
        document.getElementById('error-first_name').textContent = "Le prénom doit contenir au moins 2 caractères.";
        hasError = true;
      }

      if (!last_name) {
        document.getElementById('error-last_name').textContent = "Le nom est obligatoire.";
        hasError = true;
      } else if (last_name.length < 2) {
        document.getElementById('error-last_name').textContent = "Le nom doit contenir au moins 2 caractères.";
        hasError = true;
      }

      if (!profession) {
        document.getElementById('error-profession').textContent = "La profession est obligatoire.";
        hasError = true;
      } else if (profession.length < 3) {
        document.getElementById('error-profession').textContent = "La profession doit contenir au moins 3 caractères.";
        hasError = true;
      }

      if (!years_experience || years_experience < 0) {
        document.getElementById('error-years_experience').textContent = "Les années d'expérience doivent être un nombre positif.";
        hasError = true;
      }

      if (!completed_projects || completed_projects < 0) {
        document.getElementById('error-completed_projects').textContent = "Le nombre de projets doit être un nombre positif.";
        hasError = true;
      }

      if (!email) {
        document.getElementById('error-email').textContent = "L'email est obligatoire.";
        hasError = true;
      } else if (!email.includes('@')) {
        document.getElementById('error-email').textContent = "Veuillez entrer une adresse email valide.";
        hasError = true;
      }

      if (!phone) {
        document.getElementById('error-phone').textContent = "Le téléphone est obligatoire.";
        hasError = true;
      } else if (phone.length < 8) {
        document.getElementById('error-phone').textContent = "Le numéro de téléphone doit contenir au moins 8 chiffres.";
        hasError = true;
      }

      if (!address) {
        document.getElementById('error-address').textContent = "L'adresse est obligatoire.";
        hasError = true;
      }

      if (!bio) {
        document.getElementById('error-bio').textContent = "La biographie est obligatoire.";
        hasError = true;
      } else if (bio.length < 10) {
        document.getElementById('error-bio').textContent = "La biographie doit contenir au moins 10 caractères.";
        hasError = true;
      }

      if (hasError) return;

      const formData = new FormData(form);
      const statusDiv = document.getElementById('form-status');
      statusDiv.innerHTML = '';

      try {
        let url = '{{ base_url }}/api/about/';
        let method = 'POST';
        
        if (isEditMode && itemId) {
          url = `{{ base_url }}/api/about/edit/${itemId}/`;
          method = 'PUT';
          
          // For PUT requests with files, we need to use FormData
          const response = await fetch(url, {
            method: method,
            body: formData,
          });
          
          const data = await response.json();
          if (data.success) {
            await Swal.fire({
              icon: 'success',
              title: 'Profil modifié !',
              confirmButtonText: 'OK',
            });
            statusDiv.innerHTML = '<span style="color:green;">Profil modifié !</span>';
            
            // Dispatch form submitted event
            const event = new CustomEvent('formSubmitted', { detail: { formType: 'about' } });
            document.dispatchEvent(event);
            
            setTimeout(() => {
              window.location.href = '/dashboard';
            }, 1500);
          } else if (data.errors) {
            // Show server-side errors under each field if possible
            for (const [field, errors] of Object.entries(data.errors)) {
              const errorDiv = document.getElementById('error-' + field);
              if (errorDiv) {
                errorDiv.textContent = errors.join(', ');
              }
            }
            // Also show SweetAlert for global/server errors
            let errorList = '<ul class="form-error-list">';
            for (const [field, errors] of Object.entries(data.errors)) {
              errors.forEach(error => {
                errorList += `<li><strong>${field}:</strong> ${error}</li>`;
              });
            }
            errorList += '</ul>';
            statusDiv.innerHTML = errorList;
            Swal.fire({
              icon: 'error',
              title: 'Erreur',
              html: errorList,
              confirmButtonText: 'OK',
            });
          }
        } else {
          // Original POST logic for creating new about
          const response = await fetch(url, {
            method: method,
            body: formData,
          });
          const data = await response.json();
          if (data.success) {
            await Swal.fire({
              icon: 'success',
              title: 'Profil mis à jour !',
              confirmButtonText: 'OK',
            });
            statusDiv.innerHTML = '<span style="color:green;">Profil mis à jour !</span>';
            form.reset();
            
            // Dispatch form submitted event
            const event = new CustomEvent('formSubmitted', { detail: { formType: 'about' } });
            document.dispatchEvent(event);
          } else if (data.errors) {
          // Show server-side errors under each field if possible
          for (const [field, errors] of Object.entries(data.errors)) {
            const errorDiv = document.getElementById('error-' + field);
            if (errorDiv) {
              errorDiv.textContent = errors.join(', ');
            }
          }
          // Also show SweetAlert for global/server errors
          let errorList = '<ul class="form-error-list">';
          for (const [field, errors] of Object.entries(data.errors)) {
            errors.forEach(error => {
              errorList += `<li><strong>${field}:</strong> ${error}</li>`;
            });
          }
          errorList += '</ul>';
          statusDiv.innerHTML = errorList;
          Swal.fire({
            icon: 'error',
            title: 'Erreur',
            html: errorList,
            confirmButtonText: 'OK',
          });
          }
        }
      } catch (err) {
        statusDiv.innerHTML = '<p style="color:red;">Erreur lors de la soumission du formulaire.</p>';
        Swal.fire({
          icon: 'error',
          title: 'Erreur',
          text: 'Erreur lors de la soumission du formulaire.',
          confirmButtonText: 'OK',
        });
      }
    });
  </script>
  <script>
    fetch('{{ base_url }}/api/about/')
      .then(response => response.json())
      .then(result => {
        if (Array.isArray(result.data) && result.data.length > 0) {
          const about = result.data[0];
          // Update profile image
          if (about.photo) {
            const img = document.getElementById('sidebarProfileImg');
            if (img) {
              img.setAttribute('href', about.photo);
            }
          }
          // Update user name
          if (about.first_name && about.last_name) {
            const userName = document.getElementById('sidebarUserName');
            if (userName) {
              userName.textContent = `${about.first_name} ${about.last_name}`;
            }
          }
          // Update user role
          if (about.profession) {
            const userRole = document.getElementById('sidebarUserRole');
            if (userRole) {
              userRole.textContent = about.profession;
            }
          }
        }
      })
      .catch(err => {
        console.error('Failed to load profile image:', err);
    });

    // Mobile menu functionality
    const mobileMenuToggle = document.getElementById('mobileMenuToggle');
    const mobileSidebar = document.getElementById('mobileSidebar');
    const mobileMenuOverlay = document.getElementById('mobileMenuOverlay');
    const mobileMenuClose = document.getElementById('mobileMenuClose');

    function openMobileMenu() {
      mobileSidebar.classList.add('active');
      mobileMenuOverlay.classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function closeMobileMenu() {
      mobileSidebar.classList.remove('active');
      mobileMenuOverlay.classList.remove('active');
      document.body.style.overflow = '';
    }

    if (mobileMenuToggle) {
      mobileMenuToggle.addEventListener('click', openMobileMenu);
    }
    
    if (mobileMenuClose) {
      mobileMenuClose.addEventListener('click', closeMobileMenu);
    }
    
    if (mobileMenuOverlay) {
      mobileMenuOverlay.addEventListener('click', closeMobileMenu);
    }

    // Close menu when clicking on a link
    const mobileNavLinks = mobileSidebar.querySelectorAll('nav a');
    mobileNavLinks.forEach(link => {
      link.addEventListener('click', closeMobileMenu);
    });

    // Close menu on escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeMobileMenu();
      }
    });
  </script>
</body>
</html>
